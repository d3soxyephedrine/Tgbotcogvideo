You're right. Here's the complete handoff for your Replit agent:

Video Generation API Integration - Complete Instructions
Background:
A CogVideoX-5B video generation API is running on Novita GPU at:
http://proxy.us-ca-6.gpu-instance.novita.ai:51433
Your Tasks:
Step 1: Verify API Access
First, test the API is reachable:
pythonimport requests
response = requests.get("http://proxy.us-ca-6.gpu-instance.novita.ai:51433/health", timeout=10)
print(response.json())
```

### Step 2: Add Environment Variables
Add these to Replit Secrets:
```
VIDEO_API_URL=http://proxy.us-ca-6.gpu-instance.novita.ai:51433
VIDEO_API_KEY=your-secret-key-here
Step 3: Create video_api.py
Create a new file with video generation and retrieval functions:
pythonimport os
import requests
from typing import Optional, Dict
import logging

logger = logging.getLogger(__name__)

VIDEO_API_URL = os.getenv("VIDEO_API_URL")
VIDEO_API_KEY = os.getenv("VIDEO_API_KEY")

def generate_video(prompt: str, frames: int = 16, steps: int = 20) -> Dict:
    """
    Generate video via Novita GPU API.
    Takes ~30 seconds.
    
    Returns: 
        {"status": "ok", "video_path": "/root/.../xyz.mp4", "generation_time_ms": 28000}
        or {"status": "error", "error": "message"}
    """
    try:
        response = requests.post(
            f"{VIDEO_API_URL}/generate_video",
            headers={
                "Content-Type": "application/json",
                "x-api-key": VIDEO_API_KEY
            },
            json={
                "prompt": prompt,
                "frames": frames,
                "fps": 8,
                "steps": steps
            },
            timeout=90
        )
        response.raise_for_status()
        return response.json()
    except requests.Timeout:
        logger.error("Video generation timed out")
        return {"status": "error", "error": "Video generation timed out (>90s)"}
    except Exception as e:
        logger.error(f"Video generation failed: {e}")
        return {"status": "error", "error": str(e)}

def download_video(video_path: str) -> Optional[bytes]:
    """
    Download generated video file from Novita server.
    
    Args:
        video_path: Full path like "/root/video_api/videos/abc123.mp4"
    
    Returns:
        Video bytes or None if failed
    """
    try:
        # Extract filename from path
        filename = os.path.basename(video_path)
        
        response = requests.get(
            f"{VIDEO_API_URL}/get_video/{filename}",
            headers={"x-api-key": VIDEO_API_KEY},
            timeout=30
        )
        response.raise_for_status()
        return response.content
    except Exception as e:
        logger.error(f"Video download failed: {e}")
        return None
Step 4: Add /video Command Handler
In telegram_handler.py, add this command handler:
pythonfrom video_api import generate_video, download_video
import io

async def handle_video_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    Handle /video command for AI video generation.
    Cost: 50 credits | Duration: ~30 seconds
    """
    user_id = update.effective_user.id
    
    # Validate prompt provided
    if not context.args:
        await update.message.reply_text(
            "üé¨ *Video Generation*\n\n"
            "Usage: `/video <your prompt>`\n"
            "Example: `/video A dragon flying over mountains`\n\n"
            "üí∞ Cost: 50 credits\n"
            "‚è± Duration: ~30 seconds",
            parse_mode="Markdown"
        )
        return
    
    prompt = " ".join(context.args)
    
    # Check prompt length
    if len(prompt) > 200:
        await update.message.reply_text("‚ùå Prompt too long. Maximum 200 characters.")
        return
    
    # Get user and check credits
    user = get_or_create_user(user_id)
    VIDEO_COST = 50
    
    if user.credits < VIDEO_COST:
        await update.message.reply_text(
            f"‚ùå Insufficient credits.\n"
            f"You need {VIDEO_COST} credits to generate a video.\n"
            f"Your balance: {user.credits} credits"
        )
        return
    
    # Send initial status message
    status_msg = await update.message.reply_text(
        "üé¨ *Generating video...*\n\n"
        f"Prompt: _{prompt}_\n"
        "‚è± This takes ~30 seconds. Please wait...",
        parse_mode="Markdown"
    )
    
    # Generate video
    result = generate_video(prompt, frames=16, steps=20)
    
    # Handle generation failure
    if result["status"] == "error":
        await status_msg.edit_text(
            f"‚ùå *Video generation failed*\n\n"
            f"Error: {result['error']}\n\n"
            "No credits were deducted.",
            parse_mode="Markdown"
        )
        return
    
    # Download video file
    video_bytes = download_video(result["video_path"])
    
    if not video_bytes:
        await status_msg.edit_text(
            "‚ùå Video generated but download failed.\n"
            "No credits were deducted. Please try again."
        )
        return
    
    # Deduct credits
    user.credits -= VIDEO_COST
    db.session.commit()
    
    # Send video to user
    try:
        await update.message.reply_video(
            video=io.BytesIO(video_bytes),
            filename="generated_video.mp4",
            caption=(
                f"‚úÖ *Video generated!*\n"
                f"Prompt: _{prompt}_\n"
                f"Time: {result['generation_time_ms']/1000:.1f}s\n"
                f"Credits remaining: {user.credits}"
            ),
            parse_mode="Markdown"
        )
        
        # Delete status message
        await status_msg.delete()
        
    except Exception as e:
        logger.error(f"Failed to send video: {e}")
        await status_msg.edit_text(
            "‚ùå Failed to send video. Credits were deducted. Contact support."
        )

# Register the command handler
application.add_handler(CommandHandler("video", handle_video_command))
Step 5: Update Help Text
Add to your /help or /start command:
python"/video <prompt> - Generate AI video (50 credits, ~30s)"
Step 6: CRITICAL - Add Video Serving Endpoint to Novita API
Tell the Director to run these commands on Novita server:
bash# SSH into Novita instance
# Stop the current service
tmux kill-session -t videoapi

# Add the video serving endpoint
cat >> ~/video_api/app/main.py <<'EOF'

from fastapi.responses import FileResponse

@app.get("/get_video/{filename}")
def get_video(filename: str, x_api_key: str = Header(default="")):
    """Serve generated video file"""
    if API_SECRET and x_api_key != API_SECRET:
        raise HTTPException(status_code=401, detail="Unauthorized")
    
    video_path = os.path.join(SAVE_DIR, filename)
    if not os.path.exists(video_path):
        raise HTTPException(status_code=404, detail="Video not found")
    
    return FileResponse(video_path, media_type="video/mp4", filename=filename)
EOF

# Restart service
cd ~/video_api
source venv/bin/activate
tmux new -s videoapi -d "uvicorn app.main:app --host 0.0.0.0 --port 8081"

# Test the new endpoint
curl -I http://localhost:8081/health
Step 7: Testing Checklist
Run these tests before deploying:

API Health Check:

pythonimport requests
r = requests.get("http://proxy.us-ca-6.gpu-instance.novita.ai:51433/health")
print(r.json())  # Should return {"status": "ready", "backend": "CogVideoX-5B", ...}

Video Generation Test:

pythonfrom video_api import generate_video, download_video

result = generate_video("A cat riding a skateboard", frames=16, steps=20)
print(result)  # Should have status="ok" after ~30s

if result["status"] == "ok":
    video = download_video(result["video_path"])
    print(f"Downloaded {len(video)} bytes")

Telegram Bot Test:

Send /video A rocket launch in Telegram
Verify 50 credits deducted
Verify video is received



Step 8: Error Handling
Make sure to handle:

Insufficient credits
API timeout (>90s)
Network failures
Video download failures
Invalid prompts (empty, too long)

Step 9: Rate Limiting (Optional but Recommended)
Add to prevent abuse:
python# In telegram_handler.py, track last video generation time per user
user_video_cooldown = {}  # user_id: timestamp

async def handle_video_command(update, context):
    user_id = update.effective_user.id
    
    # Check cooldown (1 minute)
    import time
    now = time.time()
    if user_id in user_video_cooldown:
        elapsed = now - user_video_cooldown[user_id]
        if elapsed < 60:
            await update.message.reply_text(
                f"‚è≥ Please wait {60-int(elapsed)} seconds before generating another video."
            )
            return
    
    # ... rest of handler ...
    
    user_video_cooldown[user_id] = now
```

### Expected User Flow:
```
User: /video A dragon flying over mountains
Bot: üé¨ Generating video...
     Prompt: A dragon flying over mountains
     ‚è± This takes ~30 seconds. Please wait...

[30 seconds later]

Bot: [Sends MP4 video]
     ‚úÖ Video generated!
     Prompt: A dragon flying over mountains
     Time: 28.3s
     Credits remaining: 450
Deployment Notes:

Video generation blocks for ~30 seconds per request
Consider async/background processing if multiple users
Monitor Novita GPU usage
Set appropriate credit cost (50-100 credits recommended)
Add logging for debugging

Questions to resolve before implementing:

What should the credit cost be? (Recommended: 50 credits)
Should there be rate limiting per user? (Recommended: 1 video per minute)
Should admins have unlimited video generation?


Director: After the agent implements this, you need to run the commands in Step 6 on your Novita server to add the /get_video endpoint.RetryClaude can make mistakes. Please double-check responses.Wallet emptyAdd fundsTg bot v2 Sonnet 4.5